Title: gRPC layout for Python
Date: 2019-01-18 20:30
Modified: 2019-01-18 20:30
Category: Tips
Tags: gRPC, Python
Slug: grpc-python
Authors: Ted Wild
Summary: Setting up a layout for gRPC files that works seamlessly with Python

I've been using gRPC for the first time on one of my work projects.  I
was trying to set up a service definition that would work seamlessly
in C#, Java and Python.  In particular, I wanted to provide
pre-packaged libraries that contained the code generated by the
Protobuf compiler so that my users didn't have to deal with the raw
.proto files.  Instead, they could just install a package using Maven,
NuGet or pip and have all the required definitions immediately available.

Building the Maven and NuGet packages was quite straightforward.
However, it turns out that there are additional constraints on the
file layout for the Python package, which caused me to waste a bunch
of time.  The issue and solution are described in a [GitHub
issue](https://github.com/protocolbuffers/protobuf/issues/1491).

The initial setup I had was the following directory structure
* root
** proto
*** m.proto
*** s.proto
** python
*** mypackage
**** setup.py
**** __init__.py
**** proto
***** __init__.py

With m.proto

````proto
package myco.mypackage;

message R {
  string r = 1;
}
````

and s.proto
````proto
package myco.mypackage;

import "m.proto";

service S {
  rpc C (R) returns (R) {}
}
````

My plan was to generate the Python package using the following commands in the python/mypackage directory

````
python -m grpc_tools.protoc -I../../proto --python_out=proto --grpc_python_out=proto ../../proto/*.proto
python setup.py bdist_wheel
````

That command succeeded and generated a package that could be installed
using pip.  Unfortunately, importing the definitions in s.proto
doesn't work because the generated code s_pb2.proto contains the statement

````python
import s_pb2
````

which doesn't work because s_pb2 is actually in the mypackage.proto module.

There appear to be a couple workarounds:
* Keep all the protocol buffer definitions you need in a single file
* Mirror the directory structure of your protocol buffer definitions - in particular your import statements - with your target Python package

In this case, it meant setting up the repository like this
* root
** proto
*** myco
**** mypackage
***** m.proto
***** s.proto
** python
*** setup.py
*** myco
**** __init.py__
**** mypackage
***** __init.py__

Changing the import statement in s.proto to

````proto
import "myco/mypackage/m.proto" 
`````

And invoking the command from the Python directory like

````
python -m grpc_tools.protoc -I../../proto --python_out=. --grpc_python_out=. ../../proto/myco/mypackage/*.proto
python setup.py bdist_wheel
````

That way I got a package myco.mypackage and I could use

````python
from myco.mypackage import s_grpc_pb2
from myco.mypackage import m_pb2
````

As expected.  It appears that the same strategy works if you add
additional submodule structure (e.g., myco/myproduct/mypackage, etc.).

The takeaway seems to be to put all the protocol buffer definitions
for a project under the same directory structure, and possibly better
yet in the same .proto file.